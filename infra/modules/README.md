# Morpheus terraform modules

We have added some modules to make easy the infrastructure creation to install morpheus platform.

## morpheus-api-k8s-eks-aws

### Usage

This is an example. AMI values should be updated.

```
"morpheus_cluster" {
  source = "../modules/morpheus-api-k8s-eks-aws"
  db_password_secret_manager_name = "morpheus_dev"
  self_managed_web_nodes_ami = "ami-00281a874c086729c"
  self_managed_gpu_nodes_ami = "ami-09f19947f523ba9de"
}
```

### Inputs

* ***cluster_name_prefix:*** Name for the eks cluster. It will be completed with a random number to avoid conflicts with existing resources. Default value "morpheus-cluster". 

* ***cluster_version:*** K8s cluster version. Default value "1.22".

* ***cluster_ssh_key_name:*** Ssh key name for managing the cluster. It will be completed with a random number to avoid conflicts with existing resources. It'll be generated by terraform. Default value ```"morpheus-cluster-key"```.

* ***cluster_ssh_key_pem_name:*** Ssh key file name. Default value ```"morpheus-key.pem"```.

* ***self_managed_web_node_group_name:*** Name for the api node group. Default value ```"self-mng-api"```.

* ***self_managed_web_node_min_size:*** Default value ```1```.

* ***self_managed_web_node_max_size:*** Default value ```2```.

* ***self_managed_web_node_desired_size:*** Default value ```1```.

* ***self_managed_web_iam_role_name:*** Iam role for the api instances. It will be completed with a random number to avoid conflicts with existing resources. Default value ```"self-managed-node-group-api"```.

* ***self_managed_web_nodes_instance_type:***  Default value ```"t2.small"```.

* ***self_managed_web_nodes_ami:*** Default value ```"ami-081f4e51bfefc32f6"```.

* ***self_managed_gpu_node_group_name:*** Name for the gpu node group. Default value ```"self-mng-gpu"```.

* ***self_managed_gpu_node_min_size:*** Default value ```1```.

* ***self_managed_gpu_node_max_size:*** Default value ```2```.

* ***self_managed_gpu_node_desired_size:*** Default value ```1```.

* ***self_managed_gpu_nodes_instance_type:*** Default value ```"g4dn.xlarge"```.

* ***self_managed_gpu_nodes_ami:*** Default value ```"ami-05f233de75731a6a4"```.

* ***self_managed_gpu_nodes_device_name:*** Default value ```"/dev/sdh"```.

* ***self_managed_gpu_nodes_device_size:*** Default value ```20```

* ***self_managed_gpu_iam_role_name:*** Iam role for the gpu instances. It will be completed with a random number to avoid conflicts with existing resources. Default value ```"self-managed-node-group-gpu"```.

* ***vpc_name:*** VPC name. It will be completed with a random number to avoid conflicts with existing resources. Default value ```"morpheus-vpc"```.

* ***vpc_cidr:*** Default value ```"10.0.0.0/16"```.

* ***vpc_public_subnets:*** Default value ```["10.0.3.0/24", "10.0.4.0/24"]```.

* ***vpc_private_subnets:*** Default value ```["10.0.1.0/24", "10.0.2.0/24"]```.

* ***db_name:*** Default value ```"morpheus"```.

* ***db_identifier:*** Unique identifier for the db instance. It will be completed with a random number to avoid conflicts with existing resources. Default value ```"morpheus"```.

* ***db_instance_class:*** Default value ```"db.t3.micro"```.

* ***db_allocated_storage:*** Default value ```5```.

* ***db_engine:*** Default value ```"postgres"```.

* ***db_engine_version:*** Default value ```"14.5"```.

* ***db_password_secret_manager_name:*** Secret name for the db credentials. Yous should update this in the diferent envs. Default value ```"morpheus"```.

* ***s3_results_bucket_name:*** It will be completed with a random number to avoid conflicts with existing resources. Bucket to storage the promt results. Default value ```"morpheus-results"```.

* ***s3_models_bucket_name:*** Bucket to storage the models. It will be completed with a random number to avoid conflicts with existing resources. Default value ```"morpheus-models-sd"```.

* ***s3_deployment_bucket_name:*** It will be completed with a random number to avoid conflicts with existing resources. Default value ```"morpheus-deployment"```.

* ***env:*** Cluster environment. It will be used as tag in most of the cluster resources. Default value ```"dev"```.


## morpheus-frontend-s3-aws

### Usage

```
module "morpheus_frontend" {
  source = "../modules/morpheus-frontend-s3-aws"
  arn_ssl_certificate_cf_distribution = "arn:aws:acm:us-east-1:xxxxxxxxxxxx:certificate/xxxxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxxx"
  cname_frontend = "morpheus-test.monadical"
}
```

### Inputs

* ***s3_frontend_bucket_name:*** Default value ```"www.morpheus"```.

* ***arn_ssl_certificate_cf_distribution***: Arn of the ssl certificate to install in the frontend. It needs to be created in the ACM management console in aws.

* ***cname_frontend***: frontend url.

* ***frontend_cloudfront_cache_policy:*** Cache policy for the cloudfront disitribution, by default it's "Managed-CachingOptimizedDefault". Default value ```"658327ea-f89d-4fab-a63d-7e88639e58f6"```.

* ***env:*** Frontend environment. It will be used as tag in most of the resources. Default valueDefault value ```"dev"```.
